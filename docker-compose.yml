
services:
  # 反向代理服务
  # nginx-proxy:
  #   image: nginx:alpine
  #   container_name: nginx-proxy
  #   restart: unless-stopped
  #   ports:
  #     - "8080:80"
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
  #   networks:
  #     - onlyoffice-network
  #   depends_on:
  #     - onlyoffice
  # MinIO 服务
  minio:
    image: minio/minio:RELEASE.2023-12-02T10-51-33Z
    container_name: minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    ports:
      - "${MINIO_PORT}:9000"      # API端口
      - "${MINIO_CONSOLE_PORT}:9001"  # 控制台端口
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_REGION: ${MINIO_REGION}
    volumes:
    - ./minio/data:/data
    - ./minio/config:/root/.minio  # 添加配置目录
    networks:
      - onlyoffice-network

  # PostgreSQL 数据库
  postgres:
    image: postgres:13-alpine
    container_name: postgres
    restart: unless-stopped
    ports:
      - "${POSTGRES_EXTERNAL_PORT}:${POSTGRES_INTERNAL_PORT}"
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./postgres/data:/var/lib/postgresql/data
    networks:
      - onlyoffice-network

  # RabbitMQ 消息队列
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: rabbitmq
    restart: unless-stopped
    ports:
      - "${RABBITMQ_AMQP_EXTERNAL_PORT}:${RABBITMQ_AMQP_INTERNAL_PORT}"
      - "${RABBITMQ_MANAGEMENT_EXTERNAL_PORT}:${RABBITMQ_MANAGEMENT_INTERNAL_PORT}"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    volumes:
      - ./rabbitmq/data:/var/lib/rabbitmq
    networks:
      - onlyoffice-network

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - "${REDIS_EXTERNAL_PORT}:${REDIS_INTERNAL_PORT}"
    command: redis-server --appendonly yes
    volumes:
      - ./redis/data:/data
    networks:
      - onlyoffice-network

  # OnlyOffice Document Server
  onlyoffice:
    image: onlyoffice/documentserver:latest
    container_name: onlyoffice
    restart: unless-stopped
    user: "root:root"
    ports:
      - "${ONLYOFFICE_PORT}:80"
    environment:
      JWT_ENABLED: ${ONLYOFFICE_JWT_ENABLED}
      JWT_SECRET: ${ONLYOFFICE_JWT_SECRET}
      JWT_HEADER: ${ONLYOFFICE_JWT_HEADER}
      DB_TYPE: postgres
      DB_HOST: postgres
      DB_NAME: ${POSTGRES_DB}
      DB_USER: ${POSTGRES_USER}
      DB_PWD: ${POSTGRES_PASSWORD}
      AMQP_URI: amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@rabbitmq:${RABBITMQ_AMQP_INTERNAL_PORT}
      AMQP_TYPE: rabbitmq
      REDIS_SERVER_HOST: redis
      REDIS_SERVER_PORT: ${REDIS_INTERNAL_PORT}
      # 移除S3存储配置，统一使用本地文件系统
      # 允许私有IP访问
      SERVICES_COAUTHORING_ALLOW_PRIVATE_IP_ADDRESS: "true"
      SERVICES_COAUTHORING_ALLOW_PRIVATE_HOST: "true"
      SERVICES_COAUTHORING_REQUEST_FILTERING_ALLOW_PRIVATE_IPS: "true"
      SERVICES_COAUTHORING_REQUEST_FILTERING_ALLOW_INTERNAL_URLS: "true"
      SERVICES_COAUTHORING_SERVER_REJECT_UNKNOWN_HOST: "false"
      SERVICES_COAUTHORING_CONVERTER_ALLOW_PRIVATE_IP_ADDRESS: "true"
      #   # 存储配置环境变量
      STORAGE_TYPE: fs
      FS_FOLDER_PATH: /data_hekun/onlyoffice_local_url
      CACHE_ENABLED: true
      CACHE_FLUSH_INTERVAL: PT1H
     
    volumes:
      - ./onlyoffice/data:/var/www/onlyoffice/Data
      - ./onlyoffice/logs:/var/log/onlyoffice
      - ./onlyoffice-config/local.json:/etc/onlyoffice/documentserver/local.json
      - ./data_hekun/onlyoffice_local_url:/data_hekun/onlyoffice_local_url
    networks:
      - onlyoffice-network
    depends_on:
      - postgres
      - rabbitmq
      - redis
      - minio

  # Node.js 后端服务
  node-backend:
    build: ./node
    container_name: node-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      MINIO_PORT: "9000"
      MINIO_BUCKET_NAME: ${MINIO_BUCKET_NAME}
      MINIO_REGION: ${MINIO_REGION}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      SERVER_BASE_URL: "http://node-backend:8000"
      HOST_IP: ${HOST_IP}
    volumes:
      - ./node/temp_uploads:/app/temp_uploads
      - ./node/uploads:/app/uploads
    networks:
      - onlyoffice-network
    depends_on:
      - minio

networks:
  onlyoffice-network:
    driver: bridge