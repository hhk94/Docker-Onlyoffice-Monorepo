<!DOCTYPE html>
<html style="height: 100%;" lang="">
<head>
    <title>ONLYOFFICE 官方示例验证</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body style="height: 100%; margin: 0;">
<div style="height: 100%">
    <div id="placeholder"></div>
</div>
<script type="text/javascript" src="http://localhost:8080/web-apps/apps/api/documents/api.js"></script>
<script>
    // 封装初始化逻辑
    async function initEditor() {
        const config = {
            "document": {
                "title": "1766480437190-%25C3%25A9%25C2%25AB%25C2%2598%25C3%25A7%25C2%25AD%25C2%2589%25C3%25A6%25C2%2595%25C2%25B0%25C3%25A5%25C2%25AD%25C2%25A6%28%25C3%25A7%25C2%2594%25C2%25B5%25C3%25A5%25C2%25AD%25C2%2590%25C3%25A7%25C2%2589%25C2%2588%29",
                //不同的文件不能使用相同的key
                "key": "key-1766480437190",
                "fileType": "pdf",
                "url": "http://node-backend:8000/downloadfile/key-1766480437190"

            },
            "documentType": "pdf",
            "editorConfig": {
                "coEditing": {
                    "mode": "strict",
                    "change": false
                },
                "mode": "view",
                //指定编辑器为中文
                "lang": "zh"
            },
            "width": "100%",
            "height": "100%"
        };

        try {
            // 使用安全的UTF-8编码生成JWT
            config.token = await createJWT(config, 'my_secret_key_for_onlyoffice');
            window.docEditor = new DocsAPI.DocEditor("placeholder", config);
        } catch (error) {
            console.error("初始化失败:", error);
            alert("编辑器初始化失败: " + error.message);
        }
    }

    // 修复的JWT生成函数（支持UTF-8字符）
    async function createJWT(json, secret) {
        const header = {
            typ: "JWT",
            alg: "HS256"
        };

        // 使用TextEncoder进行UTF-8编码
        const encoder = new TextEncoder();
        const headerData = encoder.encode(JSON.stringify(header));
        const payloadData = encoder.encode(JSON.stringify(json));

        // Base64编码（URL安全）
        const base64EncodeURL = bytes => {
            return btoa(String.fromCharCode(...bytes))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');
        };

        const encodedHeader = base64EncodeURL(headerData);
        const encodedPayload = base64EncodeURL(payloadData);

        // 生成签名
        const algorithm = {name: "HMAC", hash: "SHA-256"};
        const key = await crypto.subtle.importKey(
                "raw",
                encoder.encode(secret),
                algorithm,
                false,
                ["sign"]
        );

        const signature = await crypto.subtle.sign(
                algorithm.name,
                key,
                encoder.encode(`${encodedHeader}.${encodedPayload}`)
        );

        return `${encodedHeader}.${encodedPayload}.${base64EncodeURL(new Uint8Array(signature))}`;
    }

    // 启动初始化
    initEditor();
</script>
</body>
</html>
