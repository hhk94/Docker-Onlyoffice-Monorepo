server {
    listen 80;
    server_name localhost;

   

    # 重写重定向URL，添加正确的端口信息
    proxy_redirect http://localhost/ http://localhost:8080/;
    proxy_redirect http://localhost:80/ http://localhost:8080/;
    proxy_redirect ~^http://localhost(:80)?/(cache/files/data/.*)$ http://localhost:8080/hekun/nginxTest/$1;

    
    # WebSocket 支持
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # 添加关键的反向代理头部，告诉OnlyOffice正确的外部访问URL
    proxy_set_header Host $host:8080;  # 明确指定端口号
    proxy_set_header X-Forwarded-Host $host:8080;
    proxy_set_header X-Forwarded-Port 8080;
    # 确保替换所有响应内容中的URL
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # 支持data_hekun路径的访问
    location ^~ /data_hekun/onlyoffice_local_url/data/ {
        # 添加特定的日志标记
        access_log /var/log/nginx/access_data_hekun.log combined;
        
        proxy_pass http://onlyoffice; # 使用容器名称访问OnlyOffice服务
        proxy_set_header Host $host:8080;  # 明确指定端口号
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Host $host:8080;
        proxy_set_header X-Forwarded-Port 8080;
    }

    # 1. 处理客户端带前缀的请求 → 转发到实际路径
    location ^~ /hekun/nginxTest/cache/files/data/ {
        # 添加特定的日志标记
        access_log /var/log/nginx/access_xxx_cache.log combined;
        
        rewrite ^/hekun/nginxTest/(cache/files/data/.*)$ /$1 break; # 去掉前缀转发到实际路径
        proxy_pass http://onlyoffice; # 使用容器名称访问OnlyOffice服务
        proxy_set_header Host $host:8080;  # 明确指定端口号
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Host $host:8080;
        proxy_set_header X-Forwarded-Port 8080;
        # 为直接访问带前缀的请求也添加替换规则
        sub_filter_types *;
        sub_filter 'http://localhost/cache/files/data/' 'http://localhost:8080/hekun/nginxTest/cache/files/data/';
        sub_filter 'http://localhost:80/cache/files/data/' 'http://localhost:8080/hekun/nginxTest/cache/files/data/';
        sub_filter 'http://localhost:8080/cache/files/data/' 'http://localhost:8080/hekun/nginxTest/cache/files/data/';
        sub_filter '/cache/files/data/' '/hekun/nginxTest/cache/files/data/';
        sub_filter_once off;
    }

    # 2. 直接处理不带前缀的/cache/files/data/请求
    location ^~ /cache/files/data/ {
        # 添加特定的日志标记
        access_log /var/log/nginx/access_cache.log combined;
        
        # 重定向到带前缀的URL
        return 301 http://$host:8080/hekun/nginxTest$request_uri;
    }

    # 3. 替换OnlyOffice响应中的路径 → 给前端返回带前缀的路径
    location / {
        # 添加特定的日志标记
        access_log /var/log/nginx/access_root.log combined;
        
        proxy_pass http://onlyoffice; # 使用容器名称访问OnlyOffice服务
        proxy_set_header Host $host:8080;  # 明确指定端口号
        proxy_set_header X-Real-IP $remote_addr;
        # 确保OnlyOffice能够正确识别请求来源
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host:8080;
        proxy_set_header X-Forwarded-Port 8080;
        
        # 增强buffer大小以确保能处理大型响应
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        
        # 使用更强大的替换规则，覆盖所有可能的URL格式
        sub_filter_types *;
        # 按优先级顺序匹配不同格式的URL
        sub_filter 'http://localhost/cache/files/data/' 'http://localhost:8080/hekun/nginxTest/cache/files/data/';
        sub_filter 'http://localhost:80/cache/files/data/' 'http://localhost:8080/hekun/nginxTest/cache/files/data/';
        sub_filter 'http://localhost:8080/cache/files/data/' 'http://localhost:8080/hekun/nginxTest/cache/files/data/';
        # 匹配相对路径
        sub_filter '/cache/files/data/' '/hekun/nginxTest/cache/files/data/';
        # 匹配可能的JavaScript字符串中的路径
        sub_filter '"/cache/files/data/' '"/hekun/nginxTest/cache/files/data/';
        sub_filter "'/cache/files/data/" "'/hekun/nginxTest/cache/files/data/";
        sub_filter_once off; # 替换所有匹配项
    }
}